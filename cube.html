<!DOCTYPE HTML>
<html>
<head>
  <link rel="stylesheet" href="css/slick.grid.css" type="text/css"/>
  <link rel="stylesheet" href="css/slick-default-theme.css" type="text/css"/>
  <link rel="stylesheet" href="css/ric.css" type="text/css"/>
</head>
<body>
  <div>
    This example loads 2 dimensions of a cube.
  </div>
  <div id="myGrid" style="width:90%;height:490px;"></div>
</table>

<script type="text/javascript" src="js/jquery-1.7.min.js"></script>
<script type="text/javascript" src="js/jquery.event.drag-2.2.js"></script>
<script type="text/javascript" src="js/slick.core.js"></script>
<script type="text/javascript" src="js/slick.data-loader.js"></script>
<script type="text/javascript" src="js/slick.grid.js"></script>
<script type="text/javascript">
  $(function() {

    var grid;
    var loader;
    var SITEDOMAIN = 'odc.dev';

    var options = {
      enableCellNavigation: false,
      enableColumnReorder: false,
      syncColumnCellResize: true,
      rowHeight: 24
    };

    var columnWidth = 350;
    var gridSize;
    var rowLabels = {}; //'hash' of uris to labels

    var datasetSlug = "additional-affordable-dwellings" ;
    var rowsDimension = "http://purl.org/linked-data/sdmx/2009/dimension#refArea";
    var rowsDimensionLabel = "Reference Area";
    var columnsDimension = "http://purl.org/linked-data/sdmx/2009/dimension#refPeriod";
    var lockedDimensions = {
      "http://opendatacommunities.org/def/housing/affordableHousingType": "http://opendatacommunities.org/def/housing/concept/affordable-housing-type/social-rent"
    }

    // var datasetSlug = "wellbeing-lsoa-happy-yesterday-mean";
    // var rowsDimension = "http://purl.org/linked-data/sdmx/2009/dimension#refArea";
    // var rowsDimensionLabel = "Reference Area";
    // var columnsDimension = "http://opendatacommunities.org/def/wellbeing/wellbeingQuestion";
    // var lockedDimensions = {
    //   "http://purl.org/linked-data/sdmx/2009/dimension#refPeriod": "http://reference.data.gov.uk/id/government-year/2011-2012"
    // }

    function getColumns() {

      function rawFormatter(row, cell, value, columnDef, dataContext) {
        return value;
      }

      var url = "http://" + SITEDOMAIN + "/data/" + datasetSlug + "/cube/dimension_values.json?dimension=" + encodeURIComponent(columnsDimension);

      // row numbers.
      var columns = [{id: '__row_num', field: '__row_num', name: '#', width: 60, cssClass: 'row-num' }];

      $.ajax({
        dataType: 'json',
        async: false,
        url: url,
        success: function(responseData, textStatus, jqXHR) {
          console.log('cols success');

          var rowDimensionLink = "<a href='" + rowsDimension + "'>" + rowsDimensionLabel + "</a>";
          // start with just the row dimension
          columns.push({id: rowsDimension, name: rowDimensionLink, field: rowsDimension, width: columnWidth, sortable:true, formatter: rawFormatter });

          for (var i=0; i < responseData.length; i++) {
            var columnUri = responseData[i]["uri"];
            var columnLabel = responseData[i]["label"] || responseData[i]["uri"];
            var columnLink = "<a href='" + columnUri + "'>" + columnLabel + "</a>";
            columns.push({id: columnUri, name: columnLink, field: columnUri, width: columnWidth, sortable:true, formatter: rawFormatter });
          }

        },
        error: function() {
          alert("error loading columns");
        }
      });

      return columns;

    }



    function getRowLabels() {

      console.log('getting row labels');

      var url = "http://" + SITEDOMAIN + "/data/" + datasetSlug + "/cube/dimension_values.json?dimension=" + encodeURIComponent(rowsDimension);

      $.ajax({
        dataType: 'json',
        async: false,
        url: url,
        success: function(responseData, textStatus, jqXHR) {
          console.log('rows success');
          var start = new Date();

          for (var i=0; i < responseData.length; i++) {
            var row = responseData[i];
            var uri = row["uri"];
            var label = row["label"];
            rowLabels[uri] = label;
          }
          console.log( 'processed row labels in: ' + (new Date() - start) + 'ms');
        },
        error: function() {
          alert("error loading columns");
        }
      });

      console.log('got row labels');

    }

    function getGridSize() {

      console.log('in get grid size');
      var url = "http://" + SITEDOMAIN + "/data/" + datasetSlug + "/cube/dimension_size.json?dimension=" + encodeURIComponent(rowsDimension);

      var gridSize = 0;
      $.ajax({
        dataType: 'json',
        async: false,
        url: url,
        success: function(responseData, textStatus, jqXHR) {
          gridSize = responseData['size'];
        },
        error: function() {
          alert("error loading columns");
        }
      });

      return gridSize;
    }

    // deals with data coming back from the loaderFunction's ajax call.
    function loaderAjaxSuccess(responseData, textStatus, jqXHR) {
      var processedData = processResponseData(responseData);
      loader.setPageOfData(jqXHR.page, processedData);
    }

    // add labels for rows.
    function processResponseData(responseData) {

      var start = new Date();

      var processedData = [];

      for( var i=0; i < responseData.length; i++ ) {

        var row = responseData[i];
        var processedRow = {};

        for (var key in row) {
          var rowData = row[key];
          if (key == rowsDimension) {
            var rowUri = rowData;
            var rowLabel = rowLabels[rowUri];

            processedRow[key] = "<a href='" + row[key] + "'>" + (rowLabel || rowUri) + "</a>";
          } else {
            var obsUri = rowData["obs"];
            var obsVal = rowData["val"];

            processedRow[key] = "<a href='" + obsUri + "'>" + (obsVal || "").toString() + "</a>";
          }
        }

        processedData.push(processedRow);
      }

      console.log( 'processing ' + processedData.length.toString() + ' rows took: ' + (new Date() - start) + 'ms');
      return processedData;
    }

    // at the moment, assume this gets all the data for the whole grid.
    // TODO: work out how to page this.
    function loaderFunction(page) {
      var url = "http://" + SITEDOMAIN + "/data/" + datasetSlug + "/cube/observations.json"
      url += "?rows_dimension=" + encodeURIComponent(rowsDimension);
      url += "&columns_dimension=" + encodeURIComponent(columnsDimension);

      for (var lockedDimension in lockedDimensions) {
        var dimensionVal = lockedDimensions[lockedDimension];
        url += "&" + encodeURIComponent(lockedDimension) + "=" + encodeURIComponent(dimensionVal);
      }

      var req = $.ajax({
        dataType: 'json',
        url: url,
        success: loaderAjaxSuccess,
        error: function() {
          alert("error loading page: " + page);
        }
      });

      req.page = page; // add a page property onto the jqXHR obj
    }

    function initGridAndLoader() {

      var gridSize = getGridSize();
      var columns = getColumns();

      console.log('gridSize ' + gridSize.toString());

      getRowLabels(); // sets a top-level var.

      loader = new Slick.Data.DataLoader(gridSize, gridSize);
      grid = new Slick.Grid("#myGrid", loader.data, columns, options);

      loader.onDataLoading.subscribe(function () {
        // TODO... show spinner.
        console.log('loading...');
      });

      loader.onDataLoaded.subscribe(function (e, args) {
        console.log(args);
        for (var i = args.from; i <= args.to; i++) {
          grid.invalidateRow(i); // causes the appropriate rows to redraw.
        }

        grid.updateRowCount(); // uses data.length
        grid.render();
        //TODO: hide spinner.
        console.log('loaded');
      });

      var viewportChangedTimer;
      grid.onViewportChanged.subscribe(function (e, args) {
        console.log('viewport changed');
        clearTimeout(viewportChangedTimer);
        // only fire this every 1/4 sec at most.
        viewportChangedTimer = setTimeout( function() {
          console.log('calling ensureData');
          var vp = grid.getViewport();
          loader.ensureData(vp.top, vp.bottom, loaderFunction);
         }, 250);
      });

      grid.onSort.subscribe(function (e, args) {


        var sortdir = args.sortAsc ? 1 : -1;
        var sortcol = args.sortCol.field;

        // THIS SORTS THE RAW DATA,
        // BUT AS IT'S LINKS THAT DOESN'T WORK - it sorts the anchors!
        // IDEA: DO SORTING ON SERVER, OR USE A CUSTOM DATAVIEW INSTEAD OF AN ARRAY?

        // var gridData = loader.data;
        // var gridDataArray = [];

        // // assign back into loader data.
        // for (var i=0; i< loader.data.length; i++) {
        //   gridDataArray[i] = loader.data[i];
        // }

        // function comparer(a, b) {
        //   var x = a[sortcol], y = b[sortcol];
        //   return (x == y ? 0 : (x > y ? 1 : -1));
        // }

        // function sort(array, comparer, ascending) {
        //   array.sort(comparer);
        //   if(ascending) {
        //     array.reverse();
        //   }
        // }

        // sort(gridDataArray, comparer, args.sortAsc);

        // // assign back into loader data.
        // for (var i=0; i< loader.data.length; i++) {
        //   gridData[i] = gridDataArray[i];
        // }

        // grid.setData(gridData);
        // grid.render();
      });

    }

    initGridAndLoader();
    var vp = grid.getViewport();
    loader.ensureData(vp.top, vp.bottom, loaderFunction);

  });
</script>
</body>
</html>
