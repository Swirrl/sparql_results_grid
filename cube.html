<!DOCTYPE HTML>
<html>
<head>
  <link rel="stylesheet" href="css/slick.grid.css" type="text/css"/>
  <link rel="stylesheet" href="css/slick-default-theme.css" type="text/css"/>
  <link rel="stylesheet" href="css/ric.css" type="text/css"/>
</head>
<body>
  <div>
    This example loads 2 dimensions of a cube.
  </div>
  <div id="myGrid" style="width:90%;height:490px;"></div>
  <div class="grid-footer" style="width:90%;height:30px;">
    <div class="grid-status"><div class="status">Status:</div> <div class='status-value'></div> <img class="busy" src="images/ajax-loader-small.gif" alt="busy" style="display:none;"></div>
  </div>
</table>

<script type="text/javascript" src="js/jquery-1.7.min.js"></script>
<script type="text/javascript" src="js/jquery.event.drag-2.2.js"></script>
<script type="text/javascript" src="js/slick.core.js"></script>
<script type="text/javascript" src="js/slick.data-loader.js"></script>
<script type="text/javascript" src="js/slick.grid.js"></script>
<script type="text/javascript">
  $(function() {

    var grid;
    var loader;
    var SITEDOMAIN = 'odc.dev';
    var PAGESIZE = 25;

    var gridOptions = {
      enableCellNavigation: false,
      enableColumnReorder: false,
      syncColumnCellResize: true,
      rowHeight: 24
    };

    var columnWidth = 350;
    var gridSize;
    var columns;
    var orderByColumn = null; // order by rows by default
    var orderDesc = false; // order asc by default

    var loadingPages = 0;

    // var datasetSlug = "additional-affordable-dwellings" ;
    // var rowsDimension = "http://purl.org/linked-data/sdmx/2009/dimension#refArea";
    // var rowsDimensionLabel = "Reference Area";
    // var columnsDimension = "http://purl.org/linked-data/sdmx/2009/dimension#refPeriod";
    // var lockedDimensions = {
    //   "http://opendatacommunities.org/def/housing/affordableHousingType": "http://opendatacommunities.org/def/housing/concept/affordable-housing-type/social-rent"
    // }

    var datasetSlug = "wellbeing-lsoa-happy-yesterday-mean";
    var rowsDimension = "http://purl.org/linked-data/sdmx/2009/dimension#refArea";
    var rowsDimensionLabel = "Reference Area";
    var columnsDimension = "http://opendatacommunities.org/def/wellbeing/wellbeingQuestion";
    var lockedDimensions = {
      "http://purl.org/linked-data/sdmx/2009/dimension#refPeriod": "http://reference.data.gov.uk/id/government-year/2011-2012"
    }


    function getColumns() {

      function rawFormatter(row, cell, value, columnDef, dataContext) {
        return value;
      }

      var url = "http://" + SITEDOMAIN + "/data/" + datasetSlug + "/cube/dimension_values.json?dimension=" + encodeURIComponent(columnsDimension);

      // start with row numbers (notice we're setting the top-level var).
      columns = [{id: '__row_num', field: '__row_num', name: '#', width: 60, cssClass: 'row-num' }];

      $.ajax({
        dataType: 'json',
        url: url,
        success: function(responseData, textStatus, jqXHR) {
          console.log('cols success');

          var rowDimensionLink = "<a href='" + rowsDimension + "'>" + rowsDimensionLabel + "</a>";
          // start with just the row dimension
          columns.push({id: rowsDimension, name: rowDimensionLink, field: rowsDimension, width: columnWidth, sortable:true, formatter: rawFormatter });

          for (var i=0; i < responseData.length; i++) {
            var columnUri = responseData[i]["uri"];
            var columnLabel = responseData[i]["label"] || responseData[i]["uri"];
            var columnLink = "<a href='" + columnUri + "'>" + columnLabel + "</a>";
            columns.push({id: columnUri, name: columnLink, field: columnUri, width: columnWidth, sortable:true, formatter: rawFormatter });
          }

          gridColsReady.notify();

        },
        error: function() {
          alert("error loading columns");
        }
      });
      return null;
    }

    function getGridSize() {

      console.log('in get grid size');
      var url = "http://" + SITEDOMAIN + "/data/" + datasetSlug + "/cube/dimension_size.json?dimension=" + encodeURIComponent(rowsDimension);

      // notice we're setting the top-level variable.
      gridSize = 0;
      $.ajax({
        dataType: 'json',
        url: url,
        success: function(responseData, textStatus, jqXHR) {
          gridSize = responseData['size'];
          gridSizeCalculated.notify();
        },
        error: function() {
          alert("error loading columns");
        }
      });
      return null;
    }

    // deals with data coming back from the loaderFunction's ajax call.
    function loaderAjaxSuccess(responseData, textStatus, jqXHR) {
      var processedData = processResponseData(responseData);
      loader.setPageOfData(jqXHR.page, processedData);
    }

    // add labels for rows.
    function processResponseData(responseData) {

      var start = new Date();

      var processedData = [];

      for( var i=0; i < responseData.length; i++ ) {

        var row = responseData[i];
        var processedRow = {};

        for (var key in row) {
          if (!(key == rowsDimension || key == "rowlabel" ) ){
            var obsUri = row[key]["obs"];
            var obsVal = row[key]["val"];
            processedRow[key] = "<a href='" + obsUri + "'>" + (obsVal || "").toString() + "</a>";
          }
        }

        var rowUri = row[rowsDimension];
        var rowLabel = row["rowlabel"];
        processedRow[rowsDimension] = "<a href='" + rowUri + "'>" + (rowLabel || rowUri) + "</a>";

        processedData.push(processedRow);
      }

      console.log( 'processing ' + processedData.length.toString() + ' rows took: ' + (new Date() - start) + 'ms');
      return processedData;
    }

    function checkLoadingPages() {
      console.log('no of loading pages');
      console.log(loadingPages);
      if (loadingPages == 0) {
        setStatus('Ready.', false);
      } else {
        setStatus('Loading data...', true);
      }
    }

    function incrementloadingPages(byAmount){
      loadingPages += byAmount;
      checkLoadingPages();
    }

    // at the moment, assume this gets all the data for the whole grid.
    // TODO: work out how to page this.
    function loaderFunction(page) {

      var url = "http://" + SITEDOMAIN + "/data/" + datasetSlug + "/cube/observations.json"
      url += "?rows_dimension=" + encodeURIComponent(rowsDimension);
      url += "&columns_dimension=" + encodeURIComponent(columnsDimension);
      url += "&per_page=" + PAGESIZE.toString();
      url += "&page=" + (page+1).toString(); // 1 based pages on server

      if (orderDesc) {
        url += "&order_desc=true";
      }

      if (orderByColumn) {
        url += "&order_by_column=" + encodeURIComponent(orderByColumn);
      }

      for (var lockedDimension in lockedDimensions) {
        var dimensionVal = lockedDimensions[lockedDimension];
        url += "&" + encodeURIComponent(lockedDimension) + "=" + encodeURIComponent(dimensionVal);
      }

      var req = $.ajax({
        dataType: 'json',
        url: url,
        success: loaderAjaxSuccess,
        error: function() {
          alert("error loading page: " + page);
        }
      });

      req.page = page; // add a page property onto the jqXHR obj

    }

    function setStatus(status, busy) {
      $(".grid-footer .grid-status .status-value").empty();
      $(".grid-footer .grid-status .status-value").append(status);

      if (busy) {
        $(".grid-footer img.busy").show();
      } else {
        $(".grid-footer img.busy").hide();
      }

    }

    function initGridAndLoader() {

      loader = new Slick.Data.DataLoader(gridSize, PAGESIZE);
      grid = new Slick.Grid("#myGrid", loader.data, columns, gridOptions);

      loader.onPageLoading.subscribe(function (e, args) {
        incrementloadingPages(+1);
      });

      loader.onPageLoaded.subscribe(function (e, args) {
        incrementloadingPages(-1);
      });

      loader.onDataLoading.subscribe(function (e, args) {
        // don't do anything
      });

      loader.onDataLoaded.subscribe(function (e, args) {
        for (var i = args.from; i <= args.to; i++) {
          grid.invalidateRow(i); // causes the appropriate rows to redraw.
        }
        grid.updateRowCount(); // uses data.length
        grid.render();
      });

      var viewportChangedTimer;
      grid.onViewportChanged.subscribe(function (e, args) {
        console.log('viewport changed');
        clearTimeout(viewportChangedTimer);
        // only fire this every 1/4 sec at most.
        viewportChangedTimer = setTimeout( function() {
          console.log('calling ensureData');
          loader.ensureData(grid.getViewport().top, grid.getViewport().bottom, loaderFunction);
         }, 250);
      });

      grid.onSort.subscribe(function (e, args) {
        orderByColumn = args.sortCol.field;
        orderDesc = args.sortAsc ? false : true;

        loader.clear();
        grid.setData(loader.data, true);
        loader.ensureData(grid.getViewport().top, grid.getViewport().bottom, loaderFunction);
      });

      loader.ensureData(grid.getViewport().top, grid.getViewport().bottom, loaderFunction);

    }

    function initGridAndLoaderWhenReady() {
      // when everything is ready, init the grid.
      if (gridColsReadyRaised && gridSizeCalculatedRaised) {
        initGridAndLoader();
      }
    }

    var gridColsReadyRaised = false;
    var gridSizeCalculatedRaised = false;

    var gridColsReady = new Slick.Event();
    var gridSizeCalculated = new Slick.Event();

    gridColsReady.subscribe(function( e, args ) {
      gridColsReadyRaised = true;
      initGridAndLoaderWhenReady();
    });

    gridSizeCalculated.subscribe(function(e, args) {
      gridSizeCalculatedRaised = true;
      initGridAndLoaderWhenReady();
    });

    setStatus('Initializing grid...', true);
    grid = new Slick.Grid("#myGrid", [], [], gridOptions);

    getColumns();
    getGridSize();

  });
</script>
</body>
</html>
