<!DOCTYPE HTML>
<html>
<head>
  <link rel="stylesheet" href="css/slick.grid.css" type="text/css"/>
  <link rel="stylesheet" href="css/slick-default-theme.css" type="text/css"/>
  <link rel="stylesheet" href="css/ric.css" type="text/css"/>
</head>
<body>
  <div>
    This example loads 2 dimensions of a cube.
  </div>
  <div id="myGrid" style="width:90%;height:490px;"></div>
</table>

<script type="text/javascript" src="js/jquery-1.7.min.js"></script>
<script type="text/javascript" src="js/jquery.event.drag-2.2.js"></script>
<script type="text/javascript" src="js/slick.core.js"></script>
<script type="text/javascript" src="js/slick.data-loader.js"></script>
<script type="text/javascript" src="js/slick.grid.js"></script>
<script type="text/javascript">
  $(function() {

    var grid;
    var loader;
    var SPARQLENDPOINT = 'http://opendatacommunities.org/sparql';
    var PAGESIZE = 403;
    var SPARQLPAGESIZE = 10000;
    var GRIDSIZE = 403; // TODO: calculate this!

    var sparqlQuery = "select ?row ?column ?val where { " +
  "graph <http://opendatacommunities.org/graph/additional-affordable-dwellings> { " +
  "  ?s <http://opendatacommunities.org/def/housing/affordableHousingType> <http://opendatacommunities.org/def/housing/concept/affordable-housing-type/social-rent> . " +
  "?s <http://purl.org/linked-data/sdmx/2009/dimension#refArea> ?row . " +
  "?s <http://purl.org/linked-data/sdmx/2009/dimension#refPeriod> ?column ." +
  "?s <http://opendatacommunities.org/def/housing/netAdditionalDwellings> ?val } " +
  "}";

    var options = {
      enableCellNavigation: false,
      enableColumnReorder: false,
      syncColumnCellResize: true,
      rowHeight: 24
    };

    var datasetURI = "http://opendatacommunities.org/data/additional-affordable-dwellings" ;
    var rowsDim = "http://purl.org/linked-data/sdmx/2009/dimension#refArea";
    var colsDim = "http://purl.org/linked-data/sdmx/2009/dimension#refPeriod";
    var columns;

    // this dimension is locked (not used yet).
    // TODO: use this in the sparql query.
    var otherDimensions = {
      "http://opendatacommunities.org/def/housing/affordableHousingType": "http://opendatacommunities.org/def/housing/concept/affordable-housing-type/social-rent"
    }

    function getColumns() {

      // TODO: make this an api call for a dataset?
      var columnsSparql = "SELECT DISTINCT ?col WHERE { " +
        "?obs <http://purl.org/linked-data/cube#dataSet> <" + datasetURI + "> . " +
        "?obs <" + colsDim + "> ?col; " +
      "} ORDER BY ?col";

      var url = SPARQLENDPOINT + ".json?query=" + encodeURIComponent(columnsSparql);

      $.ajax({
        dataType: 'json',
        async: false,
        url: url,
        success: function(responseData, textStatus, jqXHR) {
          console.log('cols success');

          columns = [rowsDim]; // start with just the row dimension
          var results = responseData["results"]["bindings"];
          for (var i=0; i < results.length; i++) {
            columns.push(results[i]["col"]["value"]);
          }

          console.log("SETTING " + columns.length + " COLS");

          loader.setColumns(columns);
        },
        error: function() {
          alert("error loading columns");
        }
      });

    }

    // deals with data coming back from the loaderFunction's ajax call.
    function loaderAjaxSuccess(responseData, textStatus, jqXHR) {

      console.log('loader ajax success');
      var results = responseData["results"]["bindings"];

      console.log(results); // the results of this query.
      console.log(columns); // this has already been set up earlier

      var page = jqXHR.page; // will always be 0 for now.
      var rows = []; // array rows to add to the grid
      var rowsData = {}; // 'hash' of row URIs to row data.

      // populate the rowsData hash.
      for (var i=0; i < results.length; i++) {
        var result = results[i];

        var rowUri = result["row"]["value"];
        var columnUri = result["column"]["value"];
        var val = result["val"]["value"];

        if (!rowsData[rowUri]) {
          rowsData[rowUri] = {};
        }
        rowsData[rowUri][columnUri] = val;
      }

      // we should now have a full populated rowsData 'hash'.
      // {
      //   "row-1-uri": {"col-1-uri": val, "col-2-uri": val},
      //   "row-2-uri": ....
      //  }

      console.log("ROWS DATA HASH");
      console.log(rowsData);

      for (var rowUri in rowsData) {
        var resultsRow = null;

        // init the results row with just the row identifier
        resultsRow = {};
        resultsRow[rowsDim] = rowUri;

        var thisRowData = rowsData[rowUri];
        for (var col in thisRowData) {
          resultsRow[col] = thisRowData[col];
        }
        rows.push(resultsRow);
      }

      console.log("ROWS");
      console.log(rows);

      // set the page of data against the loader.
      loader.setPageOfData(jqXHR.page, rows);
    }

    // at the moment, assume this gets all the data for the whole grid.
    // TODO: work out how to page this.
    function loaderFunction(page) {
      console.log('LOADING DATA FOR ' + page.toString());

      // our sparql pages are 1-based.
      var sparqlPage = page+1
      var url = SPARQLENDPOINT + ".json?query=" + encodeURIComponent(sparqlQuery) + "&page=" + (sparqlPage).toString() + "&per_page=" + SPARQLPAGESIZE.toString();

      var req = $.ajax({
        dataType: 'json',
        url: url,
        success: loaderAjaxSuccess,
        error: function() {
          alert("error loading page: " + page);
        }
      });
      req.page = page; // add a page property onto the jqXHR obj
    }

    function initGridAndLoader() {

      loader = new Slick.Data.DataLoader(GRIDSIZE, PAGESIZE);
      grid = new Slick.Grid("#myGrid", loader.data, loader.columns, options);

      loader.onColumnsChanged.subscribe(function (e, columns) {
        console.log('handle columns changed');
        grid.setColumns(columns);
      });

      getColumns();

      loader.onDataLoading.subscribe(function () {
        // TODO... show spinner.
        console.log('loading...');
      });

      loader.onDataLoaded.subscribe(function (e, args) {
        console.log(args);
        for (var i = args.from; i <= args.to; i++) {
          grid.invalidateRow(i); // causes the appropriate rows to redraw.
        }

        grid.updateRowCount(); // uses data.length
        grid.render();
        //TODO: hide spinner.
        console.log('loaded');
      });

      var viewportChangedTimer;
      grid.onViewportChanged.subscribe(function (e, args) {
        console.log('viewport changed');
        clearTimeout(viewportChangedTimer);
        // only fire this every 1/4 sec at most.
        viewportChangedTimer = setTimeout( function() {
          console.log('calling ensureData');
          var vp = grid.getViewport();
          loader.ensureData(vp.top, vp.bottom, loaderFunction);
         }, 250);
      });

    }

    initGridAndLoader();
    var vp = grid.getViewport();
    loader.ensureData(vp.top, vp.bottom, loaderFunction);

  });
</script>
</body>
</html>
