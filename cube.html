<!DOCTYPE HTML>
<html>
<head>
  <link rel="stylesheet" href="css/slick.grid.css" type="text/css"/>
  <link rel="stylesheet" href="css/slick-default-theme.css" type="text/css"/>
  <link rel="stylesheet" href="css/ric.css" type="text/css"/>
</head>
<body>
  <h1>Cube Viewer</h1>

  <div id="dimensions-controls">
    <h3>Rows</h3>
    <div id='rows-dimension-container'>
    </div>

    <h3>Columns</h3>
    <div id='columns-dimension-container'>
    </div>

    <h3>Other dimensions</h3>
    <div class="locked-dimensions">
      <!-- this will be filled in with the other dimensions -->
    </div>
  </div>

  <br/>

  <div id="myGrid" style="width:90%;height:300px;"></div>
  <div class="grid-footer" style="width:90%;height:30px;">
    <div class="grid-status"><div class="status">Status:</div> <div class='status-value'></div> <img class="busy" src="images/ajax-loader-small.gif" alt="busy" style="display:none;"></div>
  </div>
</table>

<script type="text/javascript" src="js/jquery-1.7.min.js"></script>
<script type="text/javascript" src="js/jquery.event.drag-2.2.js"></script>
<script type="text/javascript" src="js/slick.core.js"></script>
<script type="text/javascript" src="js/slick.grid.js"></script>

<script type="text/javascript" src="js/swirrl/data-loader.js"></script>
<script type="text/javascript" src="js/swirrl/cube-grid.js"></script>
<script type="text/javascript" src="js/swirrl/cube-dimension.js"></script>
<script type="text/javascript" src="js/swirrl/cube-dimension-dropdown.js"></script>
<script type="text/javascript" src="js/swirrl/cube-dimensions-controls.js"></script>

<script type="text/javascript">
  $(function() {

    var siteDomain = 'odc.dev'
      , datasetSlug = 'additional-affordable-dwellings'
      , pageSize = 25
      , elementSelector = "#myGrid"
      , cubeDimensions = null
      , cubeDimensionsControls = null
      ;

    function setStatus(status, busy) {
      $(".grid-footer .grid-status .status-value").empty();
      $(".grid-footer .grid-status .status-value").append(status);

      if (busy) {
        $(".grid-footer img.busy").show();
      } else {
        $(".grid-footer img.busy").hide();
      }
    }

    function wireUpCubeDimensionsEvents() {

      cubeDimensionsControls.onInitialized.subscribe(function (e,args) {
        // once the controls are initialized...

        // wire up the ready/busy events
        cubeDimensionsControls.onReady.subscribe(function (e, args) {
          cubeDimensionsControls.enable();

          setStatus('Re-initializing grid...', true);

          // re-init grid
          cubeGrid.clear();
          cubeGrid.initGridWhenReady();

          // set locked dims
          $.each(cubeDimensionsControls.getLockedDimensionUris(), function(i, lockedDimUri) {
            var value = cubeDimensionsControls.getLockedDimensionValues()[i];
            cubeGrid.setLockedDimensionValue(lockedDimUri, value);
          });

          // set rows and cols
          cubeGrid.setRowsDimension(cubeDimensionsControls.getRowsDimension());
          cubeGrid.setColumnsDimension(cubeDimensionsControls.getColumnsDimension());
        });

        cubeDimensionsControls.onBusy.subscribe(function (e, args) {
          cubeDimensionsControls.disable(); // disable the controls while they're busy.
        });

        // and enable the controls
        cubeDimensionsControls.enable();
      });

    }

    function setInitialGridStatus() {
      cubeDimensions = cubeGrid.getCubeDimensions();

      cubeGrid.setLockedDimensionValue(
        "http://opendatacommunities.org/def/housing/affordableHousingType",
        "http://opendatacommunities.org/def/housing/concept/affordable-housing-type/social-rent"
      );

      // for now - hard code the initial dimensions - compute this on server somehow
      cubeGrid.setColumnsDimension(cubeDimensions[0]);
      cubeGrid.setRowsDimension(cubeDimensions[1]);
      cubeGrid.onCubeDimensionsReady.unsubscribe(setInitialGridStatus);
    }

    // set initial status
    setStatus('Initializing grid...', true);

    var cubeGrid = new Swirrl.CubeGrid(elementSelector, siteDomain, datasetSlug, pageSize);

    // subscribe to grid events.
    cubeGrid.onGridReady.subscribe(function (e, args) {
      setStatus("Ready.", false); // set status bar.
    });

    var gridInitializedHandler = function (e, args) {
      cubeDimensionsControls = new Swirrl.CubeDimensionsControls(cubeGrid, "#dimensions-controls");
      wireUpCubeDimensionsEvents();
      cubeGrid.onGridInitialized.unsubscribe(gridInitializedHandler);// only do 1st time round.
    }

    cubeGrid.onGridInitialized.subscribe(gridInitializedHandler);

    cubeGrid.onGridGettingData.subscribe(function (e, args) {
      setStatus("Getting data...", true)
    });

    // tell the grid to get all it's dimensions (and set up init grid status when they're ready).
    cubeGrid.onCubeDimensionsReady.subscribe(setInitialGridStatus);
    cubeGrid.getAllDimensionsAsync();

  });
</script>
</body>
</html>
