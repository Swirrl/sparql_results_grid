<!DOCTYPE HTML>
<html>
<head>
  <link rel="stylesheet" href="css/slick.grid.css" type="text/css"/>
  <link rel="stylesheet" href="css/slick-default-theme.css" type="text/css"/>
  <link rel="stylesheet" href="css/ric.css" type="text/css"/>
</head>
<body>
  <form>
    <textarea id="query" style="width:90%;height:100px;padding:0;">select * Where { ?s ?p ?o } LIMIT 1000000</textarea>
    <br/>
    No of rows in grid:
    <select id="grid-size">
      <option value="100">100</option>
      <option value="1000">1,000</option>
      <option value="100000">100,000</option>
      <option value="1000000">1,000,000</option>
    </select>
    <br/>
    <input id="run-query" type="button" value="run sparql"/>

    <br/><br/>
  </form>
  <div>
    This example only loads the data (in 500-row chunks) based on the view port.
  </div>
  <div id="myGrid" style="width:90%;height:490px;"></div>
</table>

<script type="text/javascript" src="js/jquery-1.7.min.js"></script>
<script type="text/javascript" src="js/jquery.event.drag-2.2.js"></script>
<script type="text/javascript" src="js/slick.core.js"></script>
<script type="text/javascript" src="js/slick.ajax-sparql-loader.js"></script>
<script type="text/javascript" src="js/slick.grid.js"></script>
<script type="text/javascript">
  $(function() {
    var grid;
    var loader;

    var options = {
      enableCellNavigation: false,
      enableColumnReorder: false,
      syncColumnCellResize: true,
      rowHeight: 24
    };

    function initGridAndLoader() {

      var gridSize = parseInt($("#grid-size").val());
      console.log(gridSize);
      loader = new Slick.Data.AjaxSparqlLoader(gridSize);
      grid = new Slick.Grid("#myGrid", loader.data, loader.columns, options);

      loader.onDataLoading.subscribe(function () {
        // TODO... show spinner.
        console.log('loading...');
      });

      loader.onDataLoaded.subscribe(function (e, args) {
        console.log(args);
        for (var i = args.from; i <= args.to; i++) {
          grid.invalidateRow(i); // causes the appropriate rows to redraw.
        }

        grid.updateRowCount(); // uses data.length
        grid.render();
        //TODO: hide spinner.
        console.log('loaded');
      });

      loader.onColumnsChanged.subscribe(function (e, columns) {
        console.log(columns);
        grid.setColumns(columns);
      });

      var viewportChangedTimer;
      grid.onViewportChanged.subscribe(function (e, args) {
        clearTimeout(viewportChangedTimer);
        // only fire this every 1/4 sec at most.
        viewportChangedTimer = setTimeout( function() {
          console.log('calling ensureData');
          var vp = grid.getViewport();
          loader.ensureData(vp.top, vp.bottom);
         }, 250);
      });

    }

    initGridAndLoader();

    $("#run-query").click(function (e) {
      var query = $("#query").val();
      initGridAndLoader();
      loader.setQuery(query);
      var vp = grid.getViewport();
      loader.ensureData(vp.top, vp.bottom);
    });

  });
</script>
</body>
</html>
